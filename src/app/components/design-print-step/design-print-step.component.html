<ng-container *ngIf="produktionState$ | async as produktion">
  <div class="step-intro">
    <p class="step-title">Design & Druck</p>
    <h2>Benötigen Sie Flyer Druck und Design?</h2>
    <p>Wählen Sie Ihre Druckoptionen und Designpaket.</p>
  </div>

  <h3 class="section-title mt-4"><span>1. Flyer Druck & Anlieferung</span></h3>

  <div class="choice-card-group">
    <button type="button" class="choice-card" [class.active]="produktion.printOption === 'anliefern'" (click)="onPrintOptionSelect('anliefern')">
      <i class="mdi mdi-truck-delivery card-icon"></i>
      <span class="card-content">
        <span class="card-title">Eigene Flyer vorhanden</span>
        <span class="card-description">Kostenlos</span>
      </span>
      <span class="card-indicator"></span>
    </button>

    <button type="button" class="choice-card" [class.active]="produktion.printOption === 'service'" (click)="onPrintOptionSelect('service')">
      <i class="mdi mdi-printer card-icon"></i>
      <span class="card-content">
        <span class="card-title">Druck Service nutzen</span>
        <span class="card-description">Wir drucken ihre Flyer</span>
      </span>
      <span class="card-indicator"></span>
    </button>
  </div>

  <div *ngIf="produktion.printOption === 'anliefern'" class="mt-4">

    <div class="alert alert-light mt-0" role="alert">
      <div class="d-flex align-items-center mb-2"><span class="alert-title"><i class="mdi mdi-alert-box me-2 fs-5"></i>Hinweis</span></div>
      <ul>
        <li>Grosse Formate verursachen bei der Verteilung zusätzlichen Aufwand in der Logistik.<br><i class="mdi mdi-arrow-right-thin"></i>&nbsp;Deshalb erheben wir für die Verteilung einen <strong>pauschalen Zuschlag pro 1'000 Flyer.</strong></li>
        <li>Berechnungsgrundlage ist das <strong>Endformat im aufgeklappten/ungefalteten Zustand</strong><br><i class="mdi mdi-arrow-right-thin"></i>&nbsp;Beispiel: Ein gefalteter A4-Flyer auf A5 Format <strong>wird als A4 berechnet.</strong></li>
      </ul>
    </div>

    <fieldset class="mt-3">
      <legend><span>Flyer Format Anlieferung</span></legend>
      <div class="choice-card-group">
        <button type="button" class="choice-card"
                [class.active]="produktion.anlieferDetails.format === 'A6'"
                (click)="onFormatSelect('A6', false)">
          <i class="mdi mdi-invoice-text card-icon"></i>
          <span class="card-content"><span class="card-title">A6</span><span class="card-description">Kein Zuschlag</span></span>
          <span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card"
                [class.active]="produktion.anlieferDetails.format === 'A5'"
                (click)="onFormatSelect('A5', false)">
          <i class="mdi mdi-invoice-text card-icon"></i>
          <span class="card-content"><span class="card-title">A5</span><span class="card-description">Kein Zuschlag</span></span>
          <span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card"
                [class.active]="produktion.anlieferDetails.format === 'A4'"
                (click)="onFormatSelect('A4', false)">
          <i class="mdi mdi-invoice-text card-icon"></i>
          <span class="card-content"><span class="card-title">A4</span><span class="card-description">+ CHF 30 / 1'000 Flyer</span></span>
          <span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card"
                [class.active]="produktion.anlieferDetails.format === 'A3'"
                (click)="onFormatSelect('A3', false)">
          <i class="mdi mdi-invoice-text card-icon"></i>
          <span class="card-content"><span class="card-title">A3</span><span class="card-description">+ CHF 50 / 1'000 Flyer</span></span>
          <span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card"
                [class.active]="produktion.anlieferDetails.format === 'DIN-Lang'"
                (click)="onFormatSelect('DIN-Lang', false)">
          <i class="mdi mdi-invoice-text card-icon"></i>
          <span class="card-content"><span class="card-title">DIN Lang</span><span class="card-description">+ CHF 20 / 1'000 Flyer</span></span>
          <span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card"
                [class.active]="produktion.anlieferDetails.format === 'anderes'" (click)="onFormatSelect('anderes', false)">
          <i class="mdi mdi-invoice-text card-icon"></i>
          <span class="card-content"><span class="card-title">Anderes Format</span><span class="card-description">Wird separat offeriert</span></span>
          <span class="card-indicator"></span>
        </button>
      </div>
    </fieldset>

    <fieldset class="mt-3">
      <legend><span>Anlieferung der Flyer</span></legend>
      <div class="choice-card-group">
        <button type="button" class="choice-card"
                [class.active]="produktion.anlieferDetails.anlieferung === 'selbst'"
                (click)="onAnlieferungSelect('selbst')">
          <i class="mdi mdi-package-check card-icon"></i>
          <span class="card-content">
            <span class="card-title">Sie liefern zu uns</span>
            <span class="card-description">kostenlos</span>
          </span>
          <span class="card-indicator"></span>
        </button>

        <button type="button" class="choice-card"
                [class.active]="produktion.anlieferDetails.anlieferung === 'abholung'"
                (click)="onAnlieferungSelect('abholung')">
          <i class="mdi mdi-truck-fast card-icon"></i>
          <span class="card-content">
            <span class="card-title">Wir holen ab</span>
            <span class="card-description">+ CHF 50</span>
          </span>
          <span class="card-indicator"></span>
        </button>
      </div>
    </fieldset>
  </div>

  <div *ngIf="produktion.printOption === 'service'" class="mt-4">

    <div class="alert alert-light mt-0" role="alert">
      <div class="d-flex align-items-center mb-2"><span class="alert-title"><i class="mdi mdi-alert-box me-2 fs-5"></i>Hinweise</span></div>
      <ul>
        <li>Grosse Formate verursachen bei der Verteilung zusätzlichen Aufwand in der Logistik.<br><i class="mdi mdi-arrow-right-thin"></i>&nbsp;Deshalb erheben wir für die Verteilung einen <strong>pauschalen Zuschlag pro 1'000 Flyer.</strong></li>
        <li>Flyer Druck wird separat offeriert und wird in dieser Berechnung nicht berücksichtigt.
          <br><i class="mdi mdi-arrow-right-thin"></i>&nbsp;Die aufgeführten Zuschläge gelten <strong>nur für die Verteilung - nicht für den Druck.</strong>
          <br><i class="mdi mdi-arrow-right-thin"></i>&nbsp;Sie erhalten für den Druck eine <strong>separate Offerte per Mail.</strong>
        </li>
      </ul>
    </div>

    <fieldset class="mt-3">
      <legend><span>Flyer Format Druckservice</span></legend>
      <div class="choice-card-group">
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.format === 'A6'" (click)="onFormatSelect('A6', true)">
          <i class="mdi mdi-invoice-text card-icon"></i><span class="card-content"><span class="card-title">A6</span><span class="card-description">Kein Zuschlag</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.format === 'A5'" (click)="onFormatSelect('A5', true)">
          <i class="mdi mdi-invoice-text card-icon"></i><span class="card-content"><span class="card-title">A5</span><span class="card-description">Kein Zuschlag</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.format === 'A4'" (click)="onFormatSelect('A4', true)">
          <i class="mdi mdi-invoice-text card-icon"></i><span class="card-content"><span class="card-title">A4</span><span class="card-description">+ CHF 30 / 1'000 Flyer</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.format === 'A3'" (click)="onFormatSelect('A3', true)">
          <i class="mdi mdi-invoice-text card-icon"></i><span class="card-content"><span class="card-title">A3</span><span class="card-description">+ CHF 50 / 1'000 Flyer</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.format === 'DIN-Lang'" (click)="onFormatSelect('DIN-Lang', true)">
          <i class="mdi mdi-invoice-text card-icon"></i><span class="card-content"><span class="card-title">DIN Lang</span><span class="card-description">+ CHF 20 / 1'000 Flyer</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.format === 'anderes'" (click)="onFormatSelect('anderes', true)">
          <i class="mdi mdi-invoice-text card-icon"></i><span class="card-content"><span class="card-title">Anderes Format</span><span class="card-description">Wird separat offeriert</span></span><span class="card-indicator"></span>
        </button>
      </div>
    </fieldset>

    <fieldset class="mt-3">
      <legend><span>Grammatur</span></legend>
      <div class="choice-card-group">
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.grammatur === '90'" (click)="setDruckGrammatur('90')">
          <i class="mdi mdi-format-line-weight card-icon"></i><span class="card-content"><span class="card-title">90g/m²</span><span class="card-description">Budget Flyer</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.grammatur === '115'" (click)="setDruckGrammatur('115')">
          <i class="mdi mdi-format-line-weight card-icon"></i><span class="card-content"><span class="card-title">115g/m²</span><span class="card-description">Standard Flyer</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.grammatur === '130'" (click)="setDruckGrammatur('130')">
          <i class="mdi mdi-format-line-weight card-icon"></i><span class="card-content"><span class="card-title">130g/m²</span><span class="card-description">Werbeflyer mit Anspruch</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.grammatur === '170'" (click)="setDruckGrammatur('170')">
          <i class="mdi mdi-format-line-weight card-icon"></i><span class="card-content"><span class="card-title">170g/m²</span><span class="card-description">Für längere Haltbarkeit</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.grammatur === '250'" (click)="setDruckGrammatur('250')">
          <i class="mdi mdi-format-line-weight card-icon"></i><span class="card-content"><span class="card-title">250g/m²</span><span class="card-description">Stabil & hochwertig</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.grammatur === '300'" (click)="setDruckGrammatur('300')">
          <i class="mdi mdi-format-line-weight card-icon"></i><span class="card-content"><span class="card-title">300g/m²</span><span class="card-description">Exklusive premium Karten</span></span><span class="card-indicator"></span>
        </button>
      </div>
    </fieldset>

    <fieldset class="mt-3">
      <legend><span>Druckart</span></legend>
      <div class="choice-card-group">
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.art === 'einseitig'" (click)="setDruckArt('einseitig')">
          <i class="mdi mdi-book-open-blank-variant card-icon"></i><span class="card-content"><span class="card-title">Einseitig</span><span class="card-description">Vorne bedruckt</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.art === 'zweiseitig'" (click)="setDruckArt('zweiseitig')">
          <i class="mdi mdi-book-open-blank-variant-outline card-icon"></i><span class="card-content"><span class="card-title">Zweiseitig</span><span class="card-description">Vorne und Hinten bedruckt</span></span><span class="card-indicator"></span>
        </button>
      </div>
    </fieldset>

    <fieldset class="mt-3">
      <legend><span>Ausführung</span></legend>
      <div class="choice-card-group">
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.ausfuehrung === 'glaenzend'" (click)="setDruckAusfuehrung('glaenzend')">
          <i class="mdi mdi-creation card-icon"></i><span class="card-content"><span class="card-title">Glänzend gestrichen</span><span class="card-description">Farbstark mit Glanz</span></span><span class="card-indicator"></span>
        </button>
        <button type="button" class="choice-card" [class.active]="produktion.printServiceDetails.ausfuehrung === 'matt'" (click)="setDruckAusfuehrung('matt')">
          <i class="mdi mdi-star-four-points card-icon"></i><span class="card-content"><span class="card-title">Matt gestrichen</span><span class="card-description">Matt & edel</span></span><span class="card-indicator"></span>
        </button>
      </div>
    </fieldset>

    <fieldset class="mt-3">
      <legend><span>Auflage & Reserve</span></legend>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="druckAuflage" class="form-label">Auflage</label>
          <input type="number" class="form-control" id="druckAuflage" name="druckAuflage"
                 [(ngModel)]="druckAuflage"
                 (ngModelChange)="onDruckAuflageChange()"
                 placeholder="z.B. 5000" min="0"
                 [disabled]="currentVerteilungTyp === 'Nach Perimeter'">
          <small class="form-text text-muted" *ngIf="currentVerteilungTyp !== 'Nach Perimeter'">Wird automatisch aus Verteilgebiet berechnet.</small>
          <small class="form-text text-muted" *ngIf="currentVerteilungTyp === 'Nach Perimeter'">Anzahl Flyer für GPS-Perimeter wird nach manueller Prüfung festgelegt.</small>
        </div>
        <div class="col-md-6 mb-3">
          <label for="druckReserve" class="form-label">Zusätzliche Flyer Reserve</label>
          <input type="number" class="form-control" id="druckReserve" name="druckReserve" [(ngModel)]="druckReserve" (ngModelChange)="onDruckReserveChange()" step="100" min="0">
        </div>
      </div>
    </fieldset>
  </div>

  <!-- DESIGN PACKAGE SELECTION - ONLY WHEN PRODUCTION CHOICE IS MADE ////// -->

  <div *ngIf="produktion.printOption ==='anliefern' || produktion.printOption === 'service'">
    <h3 class="section-title"><span>2. Flyer Design</span></h3>

    <div class="choice-card-group design-package-group">
      <div class="choice-card clickable-card design-package" [class.selected]="produktion.designPackage === 'basis'" (click)="onDesignPackageSelect('basis')">
        <div class="card-header">
          <h5 class="package-name">Basis Paket</h5>
          <p class="package-slogan">Für hochwertige Designs</p>
          <p class="package-price">CHF 399</p>
          <p class="package-price-old">statt CHF 449</p>
        </div>
        <div class="card-body">
          <ul class="features list-unstyled">
            <li><i class="mdi mdi-star-four-points-small"></i> 1 Designvorschlag</li>
            <li><i class="mdi mdi-star-four-points-small"></i> 1 Korrektur</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Druckfähiges PDF</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Swiss Quality-Check</li>
          </ul>
        </div>
        <div class="card-footer">
          <span class="savings-info" *ngIf="produktion.designPackage !== 'basis'">Sie sparen CHF 50</span>
          <button type="button" class="btn btn-sm w-100" [class.btn-primary]="produktion.designPackage === 'basis'" [class.btn-outline-primary]="produktion.designPackage !== 'basis'" (click)="$event.stopPropagation(); onDesignPackageSelect('basis')">
            {{ produktion.designPackage === 'basis' ? 'Ausgewählt' : 'Auswählen' }}
          </button>
        </div>
        <i *ngIf="produktion.designPackage === 'basis'" class="mdi mdi-check-circle selected-indicator-package"></i>
      </div>

      <div class="choice-card clickable-card design-package bestseller" [class.selected]="produktion.designPackage === 'plus'" (click)="onDesignPackageSelect('plus')">
        <div class="card-header">
          <h5 class="package-name">Plus Paket <span class="badge text-bg-secondary bestseller-badge">Bestseller</span></h5>
          <p class="package-slogan">Für KMU mit Designanspruch</p>
          <p class="package-price">CHF 899</p>
          <p class="package-price-old">statt CHF 999</p>
        </div>
        <div class="card-body">
          <ul class="features list-unstyled">
            <li><i class="mdi mdi-star-four-points-small"></i> 2 Designvorschläge</li>
            <li><i class="mdi mdi-star-four-points-small"></i> 3 Korrekturen</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Druckfähiges PDF</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Swiss Quality-Check</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Quelldateien inklusive</li>
          </ul>
        </div>
        <div class="card-footer">
          <span class="savings-info" *ngIf="produktion.designPackage !== 'plus'">Sie sparen CHF 100</span>
          <button type="button" class="btn btn-sm w-100" [class.btn-primary]="produktion.designPackage === 'plus'" [class.btn-outline-primary]="produktion.designPackage !== 'plus'" (click)="$event.stopPropagation(); onDesignPackageSelect('plus')">
            {{ produktion.designPackage === 'plus' ? 'Ausgewählt' : 'Auswählen' }}
          </button>
        </div>
        <i *ngIf="produktion.designPackage === 'plus'" class="mdi mdi-check-circle selected-indicator-package"></i>
      </div>

      <div class="choice-card clickable-card design-package" [class.selected]="produktion.designPackage === 'premium'" (click)="onDesignPackageSelect('premium')">
        <div class="card-header">
          <h5 class="package-name">Premium Paket</h5>
          <p class="package-slogan">Für starkes Marketing</p>
          <p class="package-price">CHF 1’999</p>
          <p class="package-price-old">statt CHF 2’499</p>
        </div>
        <div class="card-body">
          <ul class="features list-unstyled">
            <li><i class="mdi mdi-star-four-points-small"></i> 3 Designvorschläge</li>
            <li><i class="mdi mdi-star-four-points-small"></i> 5 Korrekturen</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Druckfähiges PDF</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Swiss Quality-Check</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Quelldateien inklusive</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Logo & Branding Beratung</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Marketing-Strategie</li>
          </ul>
        </div>
        <div class="card-footer">
          <span class="savings-info" *ngIf="produktion.designPackage !== 'premium'">Sie sparen CHF 500</span>
          <button type="button" class="btn btn-sm w-100" [class.btn-primary]="produktion.designPackage === 'premium'" [class.btn-outline-primary]="produktion.designPackage !== 'premium'" (click)="$event.stopPropagation(); onDesignPackageSelect('premium')">
            {{ produktion.designPackage === 'premium' ? 'Ausgewählt' : 'Auswählen' }}
          </button>
        </div>
        <i *ngIf="produktion.designPackage === 'premium'" class="mdi mdi-check-circle selected-indicator-package"></i>
      </div>

      <div class="choice-card clickable-card design-package" [class.selected]="produktion.designPackage === 'eigenes'" (click)="onDesignPackageSelect('eigenes')">
        <div class="card-header">
          <h5 class="package-name">Eigenes Design</h5>
          <p class="package-slogan">Sie haben bereits ein Design</p>
          <p class="package-price">Kostenlos</p>
        </div>
        <div class="card-body">
          <ul class="features list-unstyled">
            <li *ngIf="produktion.printOption === 'anliefern'"><i class="mdi mdi-star-four-points-small"></i> Sie liefern uns Ihre Flyer</li>
            <li *ngIf="produktion.printOption === 'service'"><i class="mdi mdi-star-four-points-small"></i> Sie liefern ein druckfertiges PDF</li>
            <li><i class="mdi mdi-star-four-points-small"></i> Swiss Quality-Check</li>
          </ul>
        </div>
        <div class="card-footer">
          <button type="button" class="btn btn-sm w-100" [class.btn-primary]="produktion.designPackage === 'eigenes'" [class.btn-outline-primary]="produktion.designPackage !== 'eigenes'" (click)="$event.stopPropagation(); onDesignPackageSelect('eigenes')">
            {{ produktion.designPackage === 'eigenes' ? 'Ausgewählt' : 'Auswählen' }}
          </button>
        </div>
        <i *ngIf="produktion.designPackage === 'eigenes'" class="mdi mdi-check-circle selected-indicator-package"></i>
      </div>
    </div>

    <!-- UPLOAD PDF FILE ///////////////////////////////////////////////////// -->

    <div *ngIf="produktion.designPackage === 'eigenes'" class="mt-3 card p-4">
      <p class="text-muted small">Bitte laden Sie Ihr Flyer-Design als <strong>PDF-Datei</strong> hoch - max. 30 MB.</p>
      <div class="input-group">
        <input class="form-control" type="file" id="pdfFileUpload" #pdfFileUpload (change)="onPdfFileSelected($event)" accept=".pdf,application/pdf"/>
        <button type="button" class="btn btn-sm btn-primary" (click)="triggerPdfUpload()"> <i class="mdi mdi-upload"></i> hochladen</button>
      </div>
      <div *ngIf="pdfFileName" class="mt-2 small">
        Ausgewählte Datei: {{ pdfFileName }}
        <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2" (click)="removePdfFile()" title="PDF-Datei entfernen">
          <i class="mdi mdi-close-circle"></i>
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="(currentStatus$ | async) === 'invalid' && (produktion.designPackage && produktion.printOption)" class="alert alert-warning mt-3 small">
    Bitte füllen Sie alle erforderlichen Felder für die gewählte Druck/Anlieferoption aus.
  </div>
</ng-container>
