<div class="calculator-wrapper" *ngIf="kosten$ | async as kosten">
  <h3 class="calculator-title">Kostenübersicht</h3>

  <div class="cost-summary">
    <div class="cost-group">
      <h4 class="cost-group-title"><span>Flyer Verteilung</span></h4>
      <div class="table-responsive" *ngIf="kosten.selectedPlzEntriesLength > 0 && kosten.totalFlyersForDistribution > 0">
        <table class="table calculation-table">
          <thead>
          <tr>
            <th class="item-label">Beschreibung</th>
            <th class="item-quantity text-end">Flyer</th>
            <th class="item-subtotal text-end">Preis</th>
          </tr>
          </thead>
          <tbody>
          <ng-container *ngIf="kosten.distributionCostItems.length > 0">
            <tr>
              <th class="item-label" colspan="3">{{ kosten.distributionHeadline }}</th>
            </tr>
            <tr *ngFor="let item of kosten.distributionCostItems">
              <td class="item-label">{{ item.plz }} {{ item.ort }}</td>
              <td class="item-quantity text-end">{{ item.flyers | number:'1.0-0':'de-CH' }}</td>
              <td class="item-subtotal text-end">{{ item.price | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
            </tr>
          </ng-container>

          <tr class="table-light">
            <td class="item-label fw-bold">Flyer Total</td>
            <td class="item-quantity text-end fw-bold">
              <span *ngIf="!kosten.isAnderesFormatSelected">{{ kosten.totalFlyersForDistribution | number:'1.0-0':'de-CH' }}</span>
            </td>
            <td class="item-subtotal text-end fw-bold">{{ kosten.verteilungTotal | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>

          <tr *ngIf="kosten.ausgleichKleinauftragPrice > 0">
            <td class="item-label">Ausgleich Kleinauftrag<sup>3</sup></td>
            <td class="item-quantity text-end"></td>
            <td class="item-subtotal text-end">{{ kosten.ausgleichKleinauftragPrice | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>
          <tr *ngIf="kosten.expressZuschlagApplicable">
            <td class="item-label">Express Zuschlag 50%</td>
            <td class="item-quantity text-end"></td>
            <td class="item-subtotal text-end">{{ kosten.expressZuschlagPrice | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>
          <tr *ngIf="kosten.fahrzeugGpsApplicable && kosten.totalFlyersForDistribution > 0">
            <td class="item-label">Servicepauschale<sup>1</sup></td>
            <td class="item-quantity text-end"></td>
            <td class="item-subtotal text-end">{{ kosten.fahrzeugGpsPrice | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>
          <tr *ngIf="zuschlagFormatAnzeige$ | async">
            <td class="item-label">
              <span *ngIf="kosten.isAnderesFormatSelected">Zuschlag Anderes Format<sup>2</sup></span>
              <span *ngIf="!kosten.isAnderesFormatSelected && kosten.zuschlagFormatAnzeigeText">{{ kosten.zuschlagFormatAnzeigeText }}</span>
            </td>
            <td class="item-quantity text-end">
              <span *ngIf="!kosten.isAnderesFormatSelected">{{ kosten.totalFlyersForDistribution | number:'1.0-0':'de-CH' }}</span>
            </td>
            <td class="item-subtotal text-end">
              <span *ngIf="kosten.isAnderesFormatSelected">—</span>
              <span *ngIf="!kosten.isAnderesFormatSelected">{{ kosten.zuschlagFormatPrice | currency:' ':'symbol':'1.2-2':'de-CH' }}</span>
            </td>
          </tr>
          <tr *ngIf="kosten.flyerAbholungApplicable">
            <td class="item-label">Flyer Abholung</td>
            <td class="item-quantity text-end"></td>
            <td class="item-subtotal text-end">{{ kosten.flyerAbholungPrice | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>
          </tbody>
          <tfoot>
          <tr class="table-light" *ngIf="kosten.selectedPlzEntriesLength > 0 && kosten.totalFlyersForDistribution > 0">
            <td colspan="2" class="fw-bold">Zwischensumme Verteilung</td>
            <td class="text-end fw-bold">{{ kosten.subTotalDistribution | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>
          </tfoot>
        </table>
      </div>
      <div *ngIf="kosten.selectedPlzEntriesLength === 0" class="text-muted small">
        Bitte wählen Sie mindestens eine PLZ aus.
      </div>
      <div *ngIf="kosten.selectedPlzEntriesLength > 0 && kosten.totalFlyersForDistribution === 0" class="text-muted small">
        Flyer Verteilung ist nicht möglich, da keine Flyer ausgewählt wurden.
      </div>
    </div>

    <div class="cost-group" *ngIf="kosten.selectedPrintOption === 'service'">
      <h4 class="cost-group-title"><span>Flyer Druck</span></h4>
      <div class="table-responsive">
        <table class="table calculation-table">
          <tbody>
          <tr>
            <td>{{ kosten.printServiceName }}</td>
            <td class="text-end">
              <span *ngIf="kosten.printServiceCost > 0">{{ kosten.printServiceCost | currency:' ':'symbol':'1.2-2':'de-CH' }}</span>
              <span *ngIf="kosten.printServiceCost === 0">Wird separat offeriert<sup>2</sup></span>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="cost-group" *ngIf="kosten.selectedDesignPackageName && kosten.selectedDesignPackageName !== 'Kein Designpaket'">
      <h4 class="cost-group-title"><span>Flyer Design</span></h4>
      <div class="table-responsive">
        <table class="table calculation-table">
          <tbody>
          <tr class="table-light">
            <td class="item-label fw-bold">{{ kosten.selectedDesignPackageName }}</td>
            <td class="item-subtotal text-end fw-bold">{{ kosten.designPackageCost | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="cost-group total-summary mt-4" *ngIf="kosten.selectedPlzEntriesLength > 0 && kosten.totalFlyersForDistribution > 0">
      <div class="table-responsive">
        <table class="table calculation-table">
          <tbody>
          <tr class="table-light">
            <td class="fw-bold">Zwischentotal</td>
            <td class="text-end fw-bold">{{ kosten.subTotalNetto | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>
          <tr class="table-light">
            <td>Mehrwertsteuer {{ kosten.taxRatePercent }}%</td>
            <td class="text-end">{{ kosten.taxAmount | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>
          <tr class="table-light">
            <td class="fw-bold fs-5">Total</td>
            <td class="text-end fw-bold fs-5">{{ kosten.grandTotalCalculated | currency:' ':'symbol':'1.2-2':'de-CH' }}</td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="text-muted small my-4 hinweise-calculator" *ngIf="kosten.selectedPlzEntriesLength > 0 && kosten.totalFlyersForDistribution > 0">
      <strong>Hinweise</strong><br>
      <ol>
        <li>Servicepauschale deckt Fahrtkosten, detaillierte Routenplanung und GPS-Tracking für Ihre Verteilung ab.</li>
        <li>Spezielle Formate und Druckaufträge erfordern eine manuelle Prüfung. Der genaue Preis wird Ihnen anschliessend per E-Mail mitgeteilt</li>
        <li>Der Ausgleich zum Mindestbestellwert für die Verteilung (CHF 250) dient der Abdeckung von Fixkosten wie Planung und Logistik.</li>
      </ol>
    </div>

  </div>

  <div class="actions-container mt-4">
    <div *ngIf="activeStep === 1" class="d-grid">
      <button type="button" class="btn btn-lg btn-primary w-100" (click)="onRequestNext()" [disabled]="currentStepValidationStatus !== 'valid'">Weiter</button>
    </div>
    <div *ngIf="activeStep === 2" class="d-flex justify-content-between">
      <button type="button" class="btn btn-lg btn-outline-secondary w-50 me-2" (click)="onRequestPrevious()">Zurück</button>
      <button type="button" class="btn btn-lg btn-primary w-50 ms-2" (click)="onRequestNext()" [disabled]="currentStepValidationStatus !== 'valid'">Weiter</button>
    </div>
    <div *ngIf="activeStep === 3" class="d-flex justify-content-between">
      <button type="button" class="btn btn-lg btn-outline-secondary w-50 me-2" (click)="onRequestPrevious()">Zurück</button>
      <button type="button" class="btn btn-lg btn-success w-50 ms-2" (click)="onRequestSubmit()" [disabled]="currentStepValidationStatus !== 'valid'">Absenden</button>
    </div>
    <div *ngIf="activeStep === 3" class="secure-box text-center"><i class="mdi mdi-lock-check fs-4">&nbsp;</i>256-Bit TLS Verschlüsselte Übertragung</div>
  </div>
</div>
