<div class="typeahead-search-container position-relative">
  <input type="text"
         #typeaheadInputEl
         id="typeahead-plz-search"
         class="form-control"
         [placeholder]="placeholder || placeholderText"
         aria-label="PLZ, Ort oder PLZ-Bereich Suche"
         [(ngModel)]="typeaheadSearchTerm"
         (ngModelChange)="onTypeaheadInputChange($event)"
         [ngbTypeahead]="searchPlzTypeahead"
         #typeaheadInstance="ngbTypeahead"
         [resultTemplate]="resultTemplate"
         [inputFormatter]="typeaheadInputFormatter"
         (selectItem)="typeaheadItemSelected($event)"
         [editable]="true"
         [focusFirst]="false"
         (focus)="onSearchFocus()"
         (blur)="onSearchBlur()"/>
  <i class="mdi mdi-magnify search-icon"></i>
  <div *ngIf="typeaheadSearchTerm.trim().length > 0 && typeaheadSearchTerm.trim().length < 2"
       class="form-text text-muted ps-2 pt-1">
    Bitte mindestens 2 Zeichen eingeben.
  </div>
</div>

<div *ngIf="isTypeaheadListOpen"
     class="typeahead-popup"
     (mouseenter)="onTypeaheadPopupMouseEnter()"
     (mouseleave)="onTypeaheadPopupMouseLeave()">
  <!-- Typeahead-Liste wird vom ngbTypeahead-Service gerendert -->
</div>

<div *ngIf="isCustomHeaderOpen && currentSearchResultsContainer && currentSearchResultsContainer.headerText"
     class="typeahead-custom-header alert alert-info py-2 px-3 mb-0 border-bottom-0 rounded-bottom-0"
     (mouseenter)="onTypeaheadPopupMouseEnter()" (mouseleave)="onTypeaheadPopupMouseLeave()">
  <div class="d-flex justify-content-between align-items-center">
    <small [innerHTML]="currentSearchResultsContainer.headerText"></small>
    <button #selectAllButtonEl *ngIf="currentSearchResultsContainer.showSelectAllButton && currentSearchResultsContainer.entriesForSelectAllAction.length > 0"
            type="button" class="btn btn-sm btn-primary"
            (click)="handleSelectAllFromTypeaheadHeader()">
      Alle {{ currentSearchResultsContainer.entriesForSelectAllAction.length }} Ã¼bernehmen
    </button>
  </div>
</div>

<ng-template #resultTemplate let-r="result" let-t="term" let-i="index">
  <div class="typeahead-result-row"
       role="option" [id]="(typeaheadInstance?.popupId || 'default-typeahead') + '-' + (i !== undefined ? i : 'unknown_index')">
    <div (click)="handleTakeItemFromTypeahead(r, $event)" class="d-flex align-items-center w-100">
      <div class="typeahead-col-icon me-2">
        <i *ngIf="r.isGroupHeader" class="mdi mdi-select-group" title="Ortsgruppe"></i>
        <span *ngIf="!r.isGroupHeader" [innerHTML]="highlight(r.plz4, t)"></span>
      </div>
      <div class="typeahead-col-main flex-grow-1">
        <span *ngIf="r.isGroupHeader" class="fw-bold" [innerHTML]="highlight(r.ort || r.plz4, t)"></span>
        <span *ngIf="r.isGroupHeader && r.childPlzCount" class="text-muted small"> ({{r.childPlzCount}} PLZ)</span>
        <span *ngIf="!r.isGroupHeader" [innerHTML]="highlight(r.ort, t)"></span>
      </div>
      <div class="typeahead-col-key text-muted small ms-2" *ngIf="r.kt && r.kt !== 'N/A' && !r.isGroupHeader">{{ r.kt }}</div>
    </div>
  </div>
</ng-template>
