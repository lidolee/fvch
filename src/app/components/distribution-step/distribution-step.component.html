<div class="step-intro">
  <p class="step-title">Zielgebiet & Verteilung</p>
  <h2>Wo und wann sollen Ihre Flyer verteilt werden?</h2>
  <p>Definieren Sie das Zielgebiet und Verteilungsdaten für Ihre Flyerverteilung.</p>
</div>

<h3 class="section-title"><span>1. Zielgebiet</span></h3>

<div class="mb-3 row">
  <label for="verteilung-typ-select" class="col-sm-4 col-form-label">Verteilung *</label>
  <div class="col-sm-8">
    <select class="form-select form-control border border-required"
            id="verteilung-typ-select"
            name="verteilung-typ"
            required
            [(ngModel)]="currentVerteilungTyp"
            (ngModelChange)="onVerteilungTypChangeFromTemplate($event)">
      <option value="Nach PLZ">Nach PLZ Ort</option>
      <option value="Nach Perimeter">Nach Perimeter</option>
    </select>
  </div>
</div>

<!-- PLZ Auswahl UI -->
<div *ngIf="showPlzUiContainer">

  <div class="mb-3 row">
    <label for="verteilung-zielgruppe" class="col-sm-4 col-form-label">Zielgruppe *</label>
    <div class="col-sm-8">
      <select class="form-select form-control border border-required"
              id="verteilung-zielgruppe"
              name="verteilung-zielgruppe"
              required
              [(ngModel)]="currentZielgruppe"
              (ngModelChange)="onZielgruppeChange()">
        <option value="Alle Haushalte">Alle Häuser</option>
        <option value="Mehrfamilienhäuser">Mehrfamilienhäuser</option>
        <option value="Ein- und Zweifamilienhäuser">Ein- und Zweifamilienhäuser</option>
      </select>
    </div>
  </div>

  <div class="mb-3">
    <label for="typeahead-plz-search" class="form-label">Postleitzahl oder Ort eingeben (mind. 2 Zeichen)</label>
    <div class="input-group flex-nowrap">
      <span class="input-group-text"><i class="mdi mdi-magnify"></i></span>
      <input type="text"
             id="typeahead-plz-search"
             class="form-control"
             placeholder="z.B. 80 oder Züri"
             aria-label="PLZ oder Ort Suche"
             [(ngModel)]="typeaheadSearchTerm"
             (ngModelChange)="onTypeaheadInputChange($event)"
             [ngbTypeahead]="searchPlzTypeahead"
             [resultTemplate]="rtTable"
             [inputFormatter]="formatInput"
             [editable]="true"
             [focusFirst]="false"
             container="body" />
    </div>
    <div *ngIf="searching && typeaheadSearchTerm.length >= 2" class="form-text text-muted mt-1">Suche läuft...</div>
  </div>

  <!-- Typeahead Result Template als Tabelle -->
  <ng-template #rtTable let-r="result" let-t="term">
    <table class="table table-sm table-hover typeahead-results-table mb-0">
      <tbody>
      <tr>
        <!-- Fall 1: Es ist ein Gruppen/Ortseintrag (gekennzeichnet durch r.isGroupEntry) -->
        <ng-container *ngIf="r.isGroupEntry">
          <td class="ort-col" colspan="3"> <!-- colspan="3" um PLZ, Ort, KT Spalten zu überspannen -->
            <strong>{{ r.ort }}</strong>
            <span *ngIf="r.kt && r.kt !== 'N/A'"> ({{ r.kt }})</span>
          </td>
        </ng-container>
        <!-- Fall 2: Es ist ein normaler PLZ-Eintrag -->
        <ng-container *ngIf="!r.isGroupEntry">
          <td class="plz-col">{{ r.plz4 }}</td>
          <td class="ort-col">{{ r.ort }}</td>
          <td class="kt-col">{{ r.kt }}</td>
        </ng-container>
        <td class="action-col text-end">
          <button class="btn btn-sm btn-outline-primary py-0 px-1"
                  (click)="addSelectedEntryToTable(r, $event)"
                  title="Auswahl übernehmen">
            <i class="mdi mdi-plus-circle-outline"></i> Übernehmen
          </button>
        </td>
      </tr>
      </tbody>
    </table>
  </ng-template>

  <div *ngIf="searchFailed && !searching && typeaheadSearchTerm.length >= 2" class="alert alert-warning mt-2 py-2" role="alert">
    Keine Ergebnisse für "{{ typeaheadSearchTerm }}" gefunden.
  </div>

  <div class="mb-3 text-end" *ngIf="(selectedEntries$ | async)?.length">
    <button class="btn btn-outline-secondary btn-sm" type="button" (click)="clearPlzTable()"><i class="mdi mdi-delete"></i>&nbsp;Auswahl löschen</button>
  </div>

  <div class="plz-table table-responsive" *ngIf="(selectedEntries$ | async)?.length; else keineAuswahlVorlagePlz">
    <table class="table table-sm table-hover">
      <thead>
      <tr>
        <th scope="col" class="plz">PLZ</th>
        <th scope="col" class="ort">Ort</th>
        <th scope="col" class="canton">KT.</th>
        <th scope="col" class="flyer-max text-end">Flyer Max</th>
        <th scope="col" colspan="2" class="text-end">Aktionen</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let entry of (selectedEntries$ | async)">
        <td>{{ entry.plz4 }}</td>
        <td>{{ entry.ort }}</td>
        <td>{{ entry.kt }}</td>
        <td class="flyer-max text-end">{{ getFlyerMaxForEntry(entry) | number }}</td>
        <td class="has-icon text-end">
          <button class="btn btn-link btn-sm p-0" (click)="zoomToTableEntryOnMap(entry)" title="Auf Karte anzeigen">
            <i class="mdi mdi-crosshairs-gps fs-5"></i>
          </button>
        </td>
        <td class="has-icon text-end">
          <button class="btn btn-link btn-sm p-0" (click)="removePlzFromTable(entry)" title="Eintrag löschen">
            <i class="mdi mdi-delete fs-5"></i>
          </button>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
  <ng-template #keineAuswahlVorlagePlz>
    <p *ngIf="showPlzUiContainer && !searchFailed && !searching && typeaheadSearchTerm.length < 2" class="text-muted">
      Noch keine PLZ/Orte ausgewählt. Nutzen Sie die Suche (mind. 2 Zeichen) oder klicken Sie auf der Karte.
    </p>
  </ng-template>
</div>

<!-- Perimeter Auswahl UI -->
<div class="perimeter-container reminder" *ngIf="showPerimeterUiContainer">
  <div class="reminder-title">Verteilung nach GPS-Perimeter</div>
  <p>Für die Verteilung nach GPS-Perimeter benötigen wir Ihr gewünschtes Zielgebiet, um die Flyeranzahl und Kosten zu berechnen.</p>
  <ol>
    <li>Öffnen Sie <a href="https://earth.google.com" target="_blank"><strong>Google Earth</strong></a></li>
    <li>Neue <strong>lokale KML-Datei</strong> erstellen <span class="badge text-bg-secondary">CTRL + K</span><br><span class="mdi mdi-arrow-right-thin"></span>Projektname: GPS-Perimeter – Name/Firma</li>
    <li>Zielgebiet als <strong>Pfad oder Polygon</strong> einzeichnen <span class="badge text-bg-secondary">CTRL + SHIFT + L</span><br><span class="mdi mdi-arrow-right-thin"></span>In Projekt speichern</li>
    <li>Auf die <strong>drei Punkte</strong>&nbsp;<span class="badge text-bg-secondary fs-6"><i class="mdi mdi-dots-vertical"></i></span>&nbsp;beim Eintrag klicken <br><span class="mdi mdi-arrow-right-thin"></span>Als KML-Datei exportieren</li>
    <li>KML-Datei <strong>hier hochladen</strong></li>
  </ol>
  <p>Nach dem Absenden Ihrer Anfrage erhalten Sie umgehend Ihre Offerte</p>
  <strong>Preise ab CHF 250.– pro 1’000 Flyer</strong>
</div>

<!-- KARTENBEREICH JETZT KONDITIONAL -->
<div *ngIf="showPlzUiContainer">
  <div class="map-main-container">
    <div id="map-container-angular">
      <div #mapDiv id="map-angular"></div>
    </div>
    <div #loadingIndicator id="loading-indicator-angular">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Karte lädt...</span>
      </div>
      <p class="mt-2">Karte lädt...</p>
    </div>
    <div #hoverPlzDisplay id="hover-plz-display-angular">PLZ: --</div>
  </div>
  <div id="selected-plz-info-angular" class="small text-muted mt-2 mb-2">Ausgewählte PLZ (4-stellig): <span #selectedPlzInfoSpan>Keine</span></div>
</div>
<!-- KARTENBEREICH ENDE -->

<h3 class="section-title mt-4"><span>2. Verteilung Details</span></h3>
<div class="mb-3 row">
  <label for="verteilung-startdatum" class="col-sm-4 col-form-label">Zeitraum * <span class="badge rounded-pill text-bg-light hint" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip" title="Geben Sie den gewünschten Start- und Endzeitraum für die Verteilung an.">?</span></label>
  <div class="col-sm-8">
    <div class="input-group">
      <input class="form-control border border-required" type="date" name="verteilung-startdatum" id="verteilung-startdatum" placeholder="tt.mm.yyyy" required="" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip" title="Startdatum der Verteilung">
      <input class="form-control border border-required" type="date" name="verteilung-enddatum" id="verteilung-enddatum" required="" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip" title="Enddatum der Verteilung">
    </div>
  </div>
</div>
<div class="mb-3 row">
  <label for="verteilung-anlieferung" class="col-sm-4 col-form-label">Anlieferung der Flyer *</label>
  <div class="col-sm-8">
    <select class="form-select form-control border border-required" name="verteilung-anlieferung" id="verteilung-anlieferung" required="">
      <option selected="">— Anlieferung wählen</option>
      <option value="Sie liefern zu uns — kostenlos">Sie liefern zu uns&nbsp;&nbsp;➝&nbsp;&nbsp;kostenlos</option>
      <option value="Wir holen bei Ihnen ab — kostenpflichtig: 75 CHF">Wir holen bei Ihnen ab&nbsp;&nbsp;➝&nbsp;&nbsp;+ CHF 75</option>
    </select>
  </div>
</div>
<div class="mb-3 row">
  <label for="verteilung-format" class="col-sm-4 col-form-label">Format *</label>
  <div class="col-sm-8">
    <select class="form-select form-control border border-required" name="verteilung-format" id="verteilung-format" required="">
      <option selected="">— Format wählen</option>
      <option value="A5 bis A8">A5 und A6&nbsp;&nbsp;➝&nbsp;&nbsp;Kein Zuschlag</option>
      <option value="DIN Lang">DIN Lang&nbsp;&nbsp;➝&nbsp;&nbsp;+ CHF 20 / 1'000 Flyer</option>
      <option value="A4">A4&nbsp;&nbsp;➝&nbsp;&nbsp;+ CHF 30 / 1'000 Flyer</option>
      <option value="A3">A3&nbsp;&nbsp;➝&nbsp;&nbsp;+ CHF 50 / 1'000 Flyer</option>
    </select>
  </div>
</div>

<div class="mt-4 navigation-buttons">
  <p class="mb-2 small text-muted">Anzahl ausgewählter PLZ-Gebiete: {{ (selectedEntries$ | async)?.length || 0 }}</p>
  <button type="button" class="btn btn-primary" (click)="proceedToNextStep()">
    Weiter zu Design & Druck <i class="bi bi-arrow-right ms-1"></i>
  </button>
</div>

<div class="mt-3 p-2 border rounded bg-light-subtle small" *ngIf="true"> <!-- Debug-Block -->
  <p class="mb-1"><strong>Debug Info:</strong></p>
  <p class="mb-0">CurrentVerteilungTyp: <strong>{{ currentVerteilungTyp }}</strong></p>
  <p class="mb-0">CurrentZielgruppe: <strong>{{ currentZielgruppe }}</strong></p>
  <p class="mb-0">showPlzUiContainer: <strong>{{ showPlzUiContainer }}</strong></p>
  <p class="mb-0">showPerimeterUiContainer: <strong>{{ showPerimeterUiContainer }}</strong></p>
  <p class="mb-0">Map Instanz (this.map !== null): <strong>{{ !!map }}</strong></p>
  <p class="mb-0">mapDiv Element vorhanden: <strong>{{ !!mapDiv?.nativeElement }}</strong></p>
  <p class="mb-0">Anzahl Placemarks: <strong>{{ allPlacemarks?.length }}</strong></p>
  <p class="mb-0">Typeahead Search Term: <strong>{{ typeaheadSearchTerm }}</strong></p>
  <p class="mb-0">Searching: <strong>{{ searching }}</strong>, SearchFailed: <strong>{{ searchFailed }}</strong></p>
  <hr>
  <p class="mb-1">Test-Buttons für Validierungsstatus:</p>
  <button class="btn btn-sm btn-outline-success me-1" (click)="setExampleStatus('valid')">Set Valid</button>
  <button class="btn btn-sm btn-outline-warning me-1" (click)="setExampleStatus('pending')">Set Pending</button>
  <button class="btn btn-sm btn-outline-danger" (click)="setExampleStatus('invalid')">Set Invalid</button>
  <p class="mt-1 mb-0">Aktueller Text-Input-Status (weniger relevant): <strong>{{ textInputStatus }}</strong></p>
</div>
