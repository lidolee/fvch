<div class="step-intro">
  <p class="step-title">Zielgebiet & Verteilung</p>
  <h2>Wo und wann sollen Ihre Flyer verteilt werden?</h2>
  <p>Definieren Sie das Zielgebiet und Verteilungsdaten für Ihre Flyerverteilung.</p>
</div>

<h3 class="section-title"><span>1. Zielgebiet</span></h3>

<div class="mb-3 row">
  <label for="verteilung-typ-select" class="col-sm-4 col-form-label">Verteilung *</label>
  <div class="col-sm-8">
    <select class="form-select form-control border border-required"
            id="verteilung-typ-select"
            name="verteilung-typ"
            required
            [(ngModel)]="currentVerteilungTyp"
            (ngModelChange)="onVerteilungTypChangeFromTemplate($event)">
      <option value="Nach PLZ">Nach PLZ Ort</option>
      <option value="Nach Perimeter">Nach Perimeter</option>
    </select>
  </div>
</div>

<div *ngIf="showPlzUiContainer">

  <div class="map-main-container">
    <app-map *ngIf="showPlzUiContainer"
             [selectedPlzIds]="mapSelectedPlzIds"
             [highlightOnHoverPlzIds]="typeaheadHoverResultsForMapIds"
             [highlightFromTablePlzId]="mapTableHoverPlzId"
             [zoomToPlzId]="mapZoomToPlzId"
             [zoomToPlzIdList]="mapZoomToPlzIdList"
             [kmlPath]="kmlPathConstant"
             [apiKey]="apiKeyConstant"
             [mapOptions]="mapConfig"
             (plzClicked)="onPlzClickedOnMap($event)"
             (loading)="onMapLoadingStatusChanged($event)"
             (mapReady)="$event">
    </app-map>
  </div>

  <div class="my-3 row">
    <label for="verteilung-zielgruppe" class="col-sm-4 col-form-label">Zielgruppe</label>
    <div class="col-sm-8">
      <select class="form-select form-control border border-required"
              id="verteilung-zielgruppe"
              name="verteilung-zielgruppe"
              [(ngModel)]="currentZielgruppe"
              (ngModelChange)="onZielgruppeChange()">
        <option value="Alle Haushalte">Alle Häuser</option>
        <option value="Mehrfamilienhäuser">Mehrfamilienhäuser</option>
        <option value="Ein- und Zweifamilienhäuser">Ein- und Zweifamilienhäuser</option>
      </select>
    </div>
  </div>

  <div class="typeahead-search-container position-relative">
    <input type="text"
           #typeaheadInputEl
           id="typeahead-plz-search"
           class="form-control"
           placeholder="8001 oder 8001-8055 oder Zürich"
           aria-label="PLZ, Ort oder PLZ-Bereich Suche"
           [(ngModel)]="typeaheadSearchTerm"
           (ngModelChange)="onTypeaheadInputChange($event)"
           [ngbTypeahead]="searchPlzTypeahead"
           #typeaheadInstance="ngbTypeahead"
           [resultTemplate]="rtPhase2"
           [inputFormatter]="typeaheadInputFormatter"
           (selectItem)="typeaheadItemSelected($event)"
           [editable]="true"
           [focusFirst]="false"
           (focus)="onSearchFocus()"
           (blur)="onSearchBlur()"/>
    <i class="mdi mdi-magnify search-icon"></i>
  </div>

  <div *ngIf="isCustomHeaderOpen && currentSearchResultsContainer && currentSearchResultsContainer.headerText"
       class="typeahead-custom-header alert alert-info py-2 px-3 mb-0 border-bottom-0 rounded-bottom-0"
       (mouseenter)="isMouseOverPopupOrHeader = true" (mouseleave)="isMouseOverPopupOrHeader = false">
    <div class="d-flex justify-content-between align-items-center">
      <small [innerHTML]="currentSearchResultsContainer.headerText"></small>
      <button #selectAllButtonEl *ngIf="currentSearchResultsContainer.showSelectAllButton && currentSearchResultsContainer.entriesForSelectAllAction.length > 0"
              type="button" class="btn btn-sm btn-primary"
              (click)="handleSelectAllFromTypeaheadHeader()">
        Alle {{ currentSearchResultsContainer.entriesForSelectAllAction.length }} übernehmen
      </button>
    </div>
  </div>

  <ng-template #rtPhase2 let-r="result" let-t="term" let-i="index">
    <div class="typeahead-result-row"
         role="option" [id]="(typeaheadInstance?.popupId || 'default-typeahead') + '-' + (i !== undefined ? i : 'unknown_index')">
      <div (click)="handleTakeItemFromTypeahead(r, $event)" class="d-flex align-items-center w-100">
        <div class="typeahead-col-icon me-2">
          <i *ngIf="r.isGroupHeader" class="mdi mdi-select-group" title="Ortsgruppe"></i>
          <span *ngIf="!r.isGroupHeader" [innerHTML]="highlight(r.plz4, t)"></span>
        </div>
        <div class="typeahead-col-main flex-grow-1">
          <span *ngIf="r.isGroupHeader" class="fw-bold" [innerHTML]="highlight(r.ort || r.plz4, t)"></span>
          <span *ngIf="r.isGroupHeader && r.childPlzCount" class="text-muted small"> ({{r.childPlzCount}} PLZ)</span>
          <span *ngIf="!r.isGroupHeader" [innerHTML]="highlight(r.ort, t)"></span>
        </div>
        <div class="typeahead-col-key text-muted small ms-2" *ngIf="r.kt && r.kt !== 'N/A' && !r.isGroupHeader">{{ r.kt }}</div>
      </div>
    </div>
  </ng-template>

  <div *ngIf="(selectedEntries$ | async)?.length">
    <h3 class="section-title mt-4 mb-0"><span>Ihre Auswahl: {{ (selectedEntries$ | async)?.length || 0 }} PLZ</span></h3>
    <div class="delete-plz-list text-end mb-2">
      <button class="btn btn-sm btn-link text-danger" type="button" (click)="clearPlzTable()"><i class="mdi mdi-playlist-remove fs-6"></i>&nbsp;Liste löschen</button>
    </div>
  </div>

  <div class="plz-table table-responsive" *ngIf="(selectedEntries$ | async)?.length; else keineAuswahlVorlagePlz">
    <table class="table table-responsive-sm table-hover table-sm">
      <thead>
      <tr>
        <th scope="col" class="plz">PLZ</th>
        <th scope="col" class="ort">Ort</th>
        <th scope="col" class="canton">KANTON</th>
        <th scope="col" class="flyer-max text-end"
            [title]="'Flyer Max basierend auf Zielgruppe: ' + currentZielgruppe">Flyer</th>
        <th scope="col" class="flyer-limit">Flyer Limit</th>
        <th scope="col" class="actions-zoom text-end">&nbsp;</th>
        <th scope="col" class="actions-delete text-end">&nbsp;</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let entry of (selectedEntries$ | async)"
          [class.table-info]="entry.id === currentTypeaheadSelection?.id"
          (mouseenter)="highlightPlacemarkOnMapFromTable(entry.id, true)"
          (mouseleave)="highlightPlacemarkOnMapFromTable(null, false)">
        <td class="plz">{{ entry.plz4 }}</td>
        <td class="ort">{{ entry.ort }}</td>
        <td class="canton">{{ entry.kt }}</td>
        <td class="flyer-max text-end" [class.column-highlighted]="highlightFlyerMaxColumn">{{ getFlyerMaxForEntry(entry) | number }}</td>
        <td class="flyer-limit" title="Feste Anzahl an Flyern, die wir für diese PLZ verteilen. Bitte runden Sie auf die nächste 100er Zahl">
          <input class="form-control form-control-sm" type="number" [value]="getFlyerMaxForEntry(entry)" min="1" step="100" [max]="getFlyerMaxForEntry(entry) | number"/>
        </td>
        <td class="has-icon actions-zoom text-end">
          <button class="btn btn-link btn-sm p-0" (click)="zoomToTableEntryOnMap(entry)" placement="start" ngbTooltip="Auf Karte anzeigen">
            <i class="mdi mdi-map-marker-radius fs-5"></i>
          </button>
        </td>
        <td class="has-icon actions-delete text-end">
          <button class="btn btn-link btn-sm p-0" (click)="removePlzFromTable(entry)" placement="start" ngbTooltip="Eintrag löschen">
            <i class="mdi mdi-close fs-5"></i>
          </button>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <ng-template #keineAuswahlVorlagePlz>
    <div class="alert alert-light text-center mt-3" role="alert" *ngIf="showPlzUiContainer && (!selectedEntries$ || (selectedEntries$ | async)?.length === 0)">
      <div class="my-2"><strong>Beliebte Regionen</strong></div>
      <div class="popular-locations text-center">
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Zürich')">Zürich</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Bern')">Bern</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Basel')">Basel</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Luzern')">Luzern</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('St. Gallen')">St. Gallen</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Winterthur')">Winterthur</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Schaffhausen')">Schaffhausen</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Baden')">Baden</button>
        <br/>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Genève')">Genève</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Lausanne')">Lausanne</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Biel/Bienne')">Biel/Bienne</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Fribourg')">Fribourg</button>
        <br/>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Lugano')">Lugano</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Bellinzona')">Bellinzona</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Locarno')">Locarno</button>
      </div>
    </div>
  </ng-template>
</div>

<div class="perimeter-container reminder" *ngIf="showPerimeterUiContainer">
  <div class="reminder-title">Verteilung nach GPS-Perimeter</div>
  <p>Für die Verteilung nach GPS-Perimeter benötigen wir Ihr gewünschtes Zielgebiet, um die Flyeranzahl und Kosten zu berechnen.</p>
  <ol>
    <li>Öffnen Sie <a href="https://earth.google.com" target="_blank" rel="noopener noreferrer"><strong>Google Earth</strong></a></li>
    <li>Neue <strong>lokale KML-Datei</strong> erstellen <span class="badge text-bg-secondary">CTRL + K</span><br /><span class="mdi mdi-arrow-right-thin"></span>Projektname: GPS-Perimeter – Ihre Firma</li>
    <li>Zielgebiet als <strong>Pfad oder Polygon</strong> einzeichnen <span class="badge text-bg-secondary">CTRL + SHIFT + L</span><br /><span class="mdi mdi-arrow-right-thin"></span>In Projekt speichern</li>
    <li>Auf die <strong>drei Punkte</strong>&nbsp;<span class="badge text-bg-secondary fs-6"><i class="mdi mdi-dots-vertical"></i></span>&nbsp;beim Eintrag klicken <br /><span class="mdi mdi-arrow-right-thin"></span>Ort als KML-Datei exportieren</li>
    <li>KML-Datei hochladen - nutzen Sie unsere Upload-Funktion weiter unten</li>
  </ol>
  <span><strong>Preise ab CHF 250.– pro 1’000 Flyer</strong><br/>Nach dem Absenden Ihrer Anfrage erhalten Sie umgehend Ihre Offerte.</span>
</div>

<h3 class="section-title"><span>2. Verteilung Details</span></h3>

<div class="mb-3 row">
  <label for="verteilung-startdatum" class="col-sm-4 col-form-label">Zeitraum * <span class="badge rounded-pill text-bg-light hint" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip" title="Für optimale Ergebnisse empfehlen wir einen Verteilzeitraum von mindestens 7 Tagen.">Hinweis</span></label>
  <div class="col-sm-8">
    <div class="input-group">
      <input class="form-control border border-required" type="date" name="verteilung-startdatum" id="verteilung-startdatum" placeholder="tt.mm.yyyy" required data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip" title="Frühestes Startdatum für die Verteilung."/>
      <input class="form-control border border-required" type="date" name="verteilung-enddatum" id="verteilung-enddatum" placeholder="tt.mm.yyyy" required data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip" title="Spätestes Enddatum für die Verteilung."/>
    </div>
  </div>
</div>

<div class="mb-3 row">
  <label for="verteilung-anlieferung" class="col-sm-4 col-form-label">Anlieferung der Flyer *</label>
  <div class="col-sm-8">
    <select class="form-select form-control border border-required" name="verteilung-anlieferung" id="verteilung-anlieferung" required>
      <option selected value="">— Anlieferung wählen</option>
      <option value="Sie liefern zu uns — kostenlos">Sie liefern zu uns&emsp;&emsp;➝&emsp;&emsp;kostenlos</option>
      <option value="Wir holen bei Ihnen ab — kostenpflichtig: 75 CHF">Wir holen bei Ihnen ab&emsp;&emsp;➝&emsp;&emsp;+ CHF 75</option>
    </select>
  </div>
</div>

<div class="mb-3 row">
  <label for="verteilung-format" class="col-sm-4 col-form-label">Format *</label>
  <div class="col-sm-8">
    <select class="form-select form-control border border-required" name="verteilung-format" id="verteilung-format" required>
      <option selected value="">— Format wählen</option>
      <option value="A5 bis A8">A5 und A6&emsp;&emsp;➝&emsp;&emsp;Kein Zuschlag</option>
      <option value="DIN Lang">DIN Lang&emsp;&emsp;➝&emsp;&emsp;+ CHF 20 / 1'000 Flyer</option>
      <option value="A4">A4&emsp;&emsp;➝&emsp;&emsp;+ CHF 30 / 1'000 Flyer</option>
      <option value="A3">A3&emsp;&emsp;➝&emsp;&emsp;+ CHF 50 / 1'000 Flyer</option>
    </select>
  </div>
</div>
