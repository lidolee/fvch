<div class="step-intro">
  <p class="step-title">Zielgebiet & Startdatum</p>
  <h2>Wo und wann sollen Ihre Flyer verteilt werden?</h2>
  <p>Definieren Sie das Zielgebiet und Startdatum für Ihre Flyerverteilung.</p>
</div>

<h3 class="section-title"><span>1. Zielgebiet</span></h3>

<div class="mb-4 row align-items-center">
  <div class="col-12">
    <div class="choice-card-group">
      <button type="button" class="choice-card"
              [class.active]="currentVerteilungTyp === 'Nach PLZ'"
              (click)="setVerteilungTyp('Nach PLZ')">
        <i class="mdi mdi-map-marker card-icon"></i>
        <span class="card-content">
          <span class="card-title">Nach PLZ Ort</span>
          <span class="card-description">Auswahl nach PLZ oder Ort</span>
        </span>
        <span class="card-indicator"></span>
      </button>
      <button type="button" class="choice-card"
              [class.active]="currentVerteilungTyp === 'Nach Perimeter'"
              (click)="setVerteilungTyp('Nach Perimeter')">
        <i class="mdi mdi-map-marker-radius card-icon"></i>
        <span class="card-content">
          <span class="card-title">Nach Perimeter</span>
          <span class="card-description">Gebiet auf Karte zeichnen</span>
        </span>
        <span class="card-indicator"></span>
      </button>
    </div>
  </div>
</div>

<div *ngIf="showPlzUiContainer">

  <div class="map-main-container">
    <app-map *ngIf="showPlzUiContainer"
             [selectedPlzIds]="mapSelectedPlzIds"
             [highlightOnHoverPlzIds]="typeaheadHoverResultsForMapIds"
             [highlightFromTablePlzId]="mapTableHoverPlzId"
             [zoomToPlzId]="mapZoomToPlzId"
             [zoomToPlzIdList]="mapZoomToPlzIdList"
             [kmlPath]="kmlPathConstant"
             [apiKey]="apiKeyConstant"
             [mapOptions]="mapConfig"
             (plzClicked)="onPlzClickedOnMap($event)"
             (loading)="onMapLoadingStatusChanged($event)"
             (mapReady)="$event">
    </app-map>
  </div>

  <ng-container *ngIf="(selectedEntries$ | async) as selectedEntries; else showBeliebteRegionenInitially">

    <div class="typeahead-search-container position-relative mt-3">
      <input type="text"
             #typeaheadInputEl
             id="typeahead-plz-search"
             class="form-control"
             placeholder="PLZ (z.B. 80), Ort (z.B. Ad), Bereich (z.B. 8000-8050)"
             aria-label="PLZ, Ort oder PLZ-Bereich Suche"
             [(ngModel)]="typeaheadSearchTerm"
             (ngModelChange)="onTypeaheadInputChange($event)"
             [ngbTypeahead]="searchPlzTypeahead"
             #typeaheadInstance="ngbTypeahead"
             [resultTemplate]="rtPhase2"
             [inputFormatter]="typeaheadInputFormatter"
             (selectItem)="typeaheadItemSelected($event)"
             [editable]="true"
             [focusFirst]="false"
             (focus)="onSearchFocus()"
             (blur)="onSearchBlur()"/>
      <i class="mdi mdi-magnify search-icon"></i>
      <div *ngIf="typeaheadSearchTerm.trim().length > 0 && typeaheadSearchTerm.trim().length < 2"
           class="form-text text-muted ps-2 pt-1">
        Bitte mindestens 2 Zeichen eingeben.
      </div>
    </div>

    <div *ngIf="isTypeaheadListOpen"
         class="typeahead-popup"
         (mouseenter)="onTypeaheadPopupMouseEnter()"
         (mouseleave)="onTypeaheadPopupMouseLeave()">
      <!-- Typeahead-Liste wird vom ngbTypeahead-Service gerendert -->
    </div>
    <div *ngIf="isCustomHeaderOpen && currentSearchResultsContainer && currentSearchResultsContainer.headerText"
         class="typeahead-custom-header alert alert-info py-2 px-3 mb-0 border-bottom-0 rounded-bottom-0"
         (mouseenter)="onTypeaheadPopupMouseEnter()" (mouseleave)="onTypeaheadPopupMouseLeave()">
      <div class="d-flex justify-content-between align-items-center">
        <small [innerHTML]="currentSearchResultsContainer.headerText"></small>
        <button #selectAllButtonEl *ngIf="currentSearchResultsContainer.showSelectAllButton && currentSearchResultsContainer.entriesForSelectAllAction.length > 0"
                type="button" class="btn btn-sm btn-primary"
                (click)="handleSelectAllFromTypeaheadHeader()">
          Alle {{ currentSearchResultsContainer.entriesForSelectAllAction.length }} übernehmen
        </button>
      </div>
    </div>

    <div class="my-4 row" *ngIf="selectedEntries && selectedEntries.length > 0">
      <div class="col-sm-12">
        <div class="choice-card-group choice-card-group-zielgruppe">
          <button type="button" class="choice-card"
                  [class.active]="currentZielgruppe === 'Alle Haushalte'"
                  (click)="setZielgruppe('Alle Haushalte')">
            <i class="mdi mdi-home-city card-icon"></i>
            <span class="card-content">
              <span class="card-title">Alle Häuser</span>
              <span class="card-description">Max. Reichweite</span>
            </span>
            <span class="card-indicator"></span>
          </button>
          <button type="button" class="choice-card"
                  [class.active]="currentZielgruppe === 'Mehrfamilienhäuser'"
                  (click)="setZielgruppe('Mehrfamilienhäuser')">
            <i class="mdi mdi-office-building card-icon"></i>
            <span class="card-content">
              <span class="card-title">MFH</span>
              <span class="card-description">Mehrfamilienhäuser</span>
            </span>
            <span class="card-indicator"></span>
          </button>
          <button type="button" class="choice-card"
                  [class.active]="currentZielgruppe === 'Ein- und Zweifamilienhäuser'"
                  (click)="setZielgruppe('Ein- und Zweifamilienhäuser')">
            <i class="mdi mdi-home-variant card-icon"></i>
            <span class="card-content">
              <span class="card-title">EFH</span>
              <span class="card-description">1–2 Familienhäuser</span>
            </span>
            <span class="card-indicator"></span>
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="selectedEntries && selectedEntries.length > 0">
      <h3 class="section-title mt-4 mb-0"><span>Ihre Auswahl: {{ selectedEntries.length }} PLZ</span></h3>
      <div class="delete-plz-list text-end mt-2 mb-4">
        <button class="btn btn-sm btn-outline-danger" type="button" (click)="clearPlzTable()"><i class="mdi mdi-playlist-remove fs-6"></i>&nbsp;Liste löschen</button>
      </div>
    </div>

    <div *ngIf="selectedEntries && selectedEntries.length > 0; else showBeliebteRegionenWhenEmpty">
      <app-plz-selection-table
        [entries]="selectedEntries"
        [currentZielgruppe]="currentZielgruppe"
        [highlightFlyerMaxColumn]="highlightFlyerMaxColumn"
        (remove)="removePlzFromTable($event)"
        (zoom)="zoomToTableEntryOnMap($event)"
        (highlight)="highlightPlacemarkOnMapFromTable($event.plzId, $event.highlight)">
      </app-plz-selection-table>
    </div>

    <ng-template #showBeliebteRegionenWhenEmpty>
      <div class="alert alert-light text-center mt-3" role="alert" *ngIf="showPlzUiContainer">
        <div class="popular-locations text-center">
          <div class="my-2"><h6 class="text-uppercase">Beliebte Regionen</h6></div>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Zürich')">Zürich</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Bern')">Bern</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Basel')">Basel</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Luzern')">Luzern</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('St. Gallen')">St. Gallen</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Winterthur')">Winterthur</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Schaffhausen')">Schaffhausen</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Baden')">Baden</button>
          <br/>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Genève')">Genève</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Lausanne')">Lausanne</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Biel/Bienne')">Biel/Bienne</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Fribourg')">Fribourg</button>
          <br/>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Lugano')">Lugano</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Bellinzona')">Bellinzona</button>
          <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Locarno')">Locarno</button>
        </div>
      </div>
    </ng-template>
  </ng-container>

  <ng-template #showBeliebteRegionenInitially>
    <div class="alert alert-light text-center mt-3" role="alert" *ngIf="showPlzUiContainer">
      <div class="my-2"><strong>Beliebte Regionen</strong></div>
      <div class="popular-locations text-center">
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Zürich')">Zürich</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Bern')">Bern</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Basel')">Basel</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Luzern')">Luzern</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('St. Gallen')">St. Gallen</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Winterthur')">Winterthur</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Schaffhausen')">Schaffhausen</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Baden')">Baden</button>
        <br/>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Genève')">Genève</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Lausanne')">Lausanne</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Biel/Bienne')">Biel/Bienne</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Fribourg')">Fribourg</button>
        <br/>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Lugano')">Lugano</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Bellinzona')">Bellinzona</button>
        <button type="button" class="btn btn-sm btn-link me-1 mb-1" (click)="quickSearch('Locarno')">Locarno</button>
      </div>
    </div>
  </ng-template>

  <ng-template #rtPhase2 let-r="result" let-t="term" let-i="index">
    <div class="typeahead-result-row"
         role="option" [id]="(typeaheadInstance?.popupId || 'default-typeahead') + '-' + (i !== undefined ? i : 'unknown_index')">
      <div (click)="handleTakeItemFromTypeahead(r, $event)" class="d-flex align-items-center w-100">
        <div class="typeahead-col-icon me-2">
          <i *ngIf="r.isGroupHeader" class="mdi mdi-select-group" title="Ortsgruppe"></i>
          <span *ngIf="!r.isGroupHeader" [innerHTML]="highlight(r.plz4, t)"></span>
        </div>
        <div class="typeahead-col-main flex-grow-1">
          <span *ngIf="r.isGroupHeader" class="fw-bold" [innerHTML]="highlight(r.ort || r.plz4, t)"></span>
          <span *ngIf="r.isGroupHeader && r.childPlzCount" class="text-muted small"> ({{r.childPlzCount}} PLZ)</span>
          <span *ngIf="!r.isGroupHeader" [innerHTML]="highlight(r.ort, t)"></span>
        </div>
        <div class="typeahead-col-key text-muted small ms-2" *ngIf="r.kt && r.kt !== 'N/A' && !r.isGroupHeader">{{ r.kt }}</div>
      </div>
    </div>
  </ng-template>
</div>

<div class="perimeter-container reminder" *ngIf="showPerimeterUiContainer">
  <div class="reminder-title">Verteilung nach GPS-Perimeter</div>
  <p>Für die Verteilung nach GPS-Perimeter benötigen wir Ihr gewünschtes Zielgebiet, um die Flyeranzahl und Kosten zu berechnen.</p>
  <ol>
    <li>Öffnen Sie <a href="https://earth.google.com" target="_blank" rel="noopener noreferrer"><strong>Google Earth</strong></a></li>
    <li>Neue <strong>lokale KML-Datei</strong> erstellen <span class="badge text-bg-secondary">CTRL + K</span><br /><i class="mdi mdi-arrow-right-thin"></i>Projektname: GPS-Perimeter – Ihre Firma</li>
    <li>Zielgebiet als <strong>Pfad oder Polygon</strong> einzeichnen <span class="badge text-bg-secondary">CTRL + SHIFT + L</span><br /><i class="mdi mdi-arrow-right-thin"></i>In Projekt speichern</li>
    <li>Auf die <strong>drei Punkte</strong>&nbsp;<span class="badge text-bg-secondary fs-6"><i class="mdi mdi-dots-vertical"></i></span>&nbsp;beim Eintrag klicken <br /><i class="mdi mdi-arrow-right-thin"></i>KML-Datei exportieren</li>
    <li>KML-Datei hochladen - nutzen Sie unsere Upload-Funktion weiter unten</li>
  </ol>
  <span><strong>Preise ab CHF 250.– pro 1’000 Flyer</strong><br/>Nach dem Absenden Ihrer Anfrage erhalten Sie umgehend Ihre Offerte.</span>
</div>

<h3 class="section-title"><span>2. Startdatum</span></h3>

<div class="mb-3 row">
  <label for="verteilung-startdatum" class="col-sm-4 col-form-label">Startdatum der Verteilung</label>
  <div class="col-sm-8">
    <div class="input-group">
      <input class="form-control border border-required" type="date" name="verteilung-startdatum" id="verteilung-startdatum"
             [(ngModel)]="verteilungStartdatum"
             [min]="minVerteilungStartdatum"
             (change)="onStartDateChange()"
             required
             title="Frühestes Startdatum für die Verteilung."/>
    </div>
  </div>
</div>

<div class="row mb-3" *ngIf="showExpressSurcharge">
  <div class="col-sm-8 offset-sm-4">
    <div class="alert alert-light" role="alert">
      <div class="d-flex align-items-center mb-2">
        <span class="alert-title"><i class="mdi mdi-alert-box me-2 fs-5"></i>Express-Zuschlag</span>
      </div>
      <div>Kurzfristiges Startdatum <strong class="text-danger">50% Express-Zuschlag</strong></div>

      <div class="mt-2">Start ab <strong>{{ getFormattedDefaultStandardDateForDisplay() }}</strong> oder später: kein Zuschlag.</div>

      <div class="row gx-3">
        <div class="col-6">
          <button type="button" class="btn btn-sm w-100 btn-outline-danger mt-3" (click)="avoidExpressSurcharge()">
            Express vermeiden
          </button>
        </div>
        <div class="col-6">
          <button type="button" class="btn btn-sm w-100 btn-outline-success mt-3" (click)="confirmExpressSurcharge()">
            Express buchen
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
