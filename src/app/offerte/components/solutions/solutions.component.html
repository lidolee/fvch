<div class="cardbox solutions">
  <div class="cardbox-body">
    <div class="row">
      <div class="col-lg-9">
        <h6 class="cardbox-step">Schritt 1</h6>
        <h3 class="cardbox-title">Leistungen auswählen</h3>
        <p class="cardbox-text">Wählen Sie die gewünschten Dienstleistungen aus.</p>
      </div>
      <div class="col-lg-3 align-self-center">
        <button type="button"
                [class]="isStepCompleted ? 'cardbox-button secondary' : 'cardbox-button'"
                [disabled]="disabled"
                [class.disabled]="disabled"
                (click)="openSolutionsModal(solutionsModal)">
          {{ isStepCompleted ? 'Bearbeiten' : 'Weiter' }}
        </button>
      </div>
    </div>
  </div>
</div>

<ng-template #solutionsModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">Flyer Dienstleistungen</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>

  <div class="modal-body">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-8">
          <form [formGroup]="solutionsForm" novalidate>
            <p>Wählen Sie die gewünschten Dienstleistungen für Ihre Flyer:</p>

            <!-- Jede "solution-option card" ist ein Akkordeon-Item -->
            <div *ngFor="let sol of availableSolutions; let i = index" class="solution-option card mb-3">

              <!-- TEIL 1: Der klickbare Header des Akkordeon-Items -->
              <div class="solution-accordion-header card-header"
                   (click)="toggleSolutionSelection(sol.id)"
                   [class.selected]="isSolutionSelected(sol.id)"
                   role="button"
                   tabindex="0"
                   (keydown.enter)="toggleSolutionSelection(sol.id)"
                   (keydown.space)="toggleSolutionSelection(sol.id)"
                   [attr.aria-labelledby]="'solution-title-' + i">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 me-3">
                    <i class="bi {{sol.icon}} h2"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h5 class="card-title mb-1" [id]="'solution-title-' + i">{{ sol.name }}</h5>
                    <p class="card-text small text-muted mb-0">{{ sol.description }}</p>
                  </div>
                  <div class="form-check ms-3">
                    <input class="form-check-input"
                           type="checkbox"
                           [checked]="isSolutionSelected(sol.id)"
                           (click)="$event.stopPropagation()"
                    (change)="toggleSolutionSelection(sol.id)"
                    [attr.aria-label]="'Select ' + sol.name">
                  </div>
                </div>
              </div>

              <!-- TEIL 2: Der Konfigurations-Body des Akkordeon-Items (bedingt sichtbar) -->
              <!-- Wichtig: (click)="$event.stopPropagation()" hier, damit Klicks im Konfig-Bereich nicht das Akkordeon schließen -->
              <div *ngIf="isSolutionSelected(sol.id)"
                   class="solution-accordion-body card-body border-top"
                   (click)="$event.stopPropagation()">

                <ng-container [ngSwitch]="sol.id">
                  <app-flyer-design-config *ngSwitchCase="'design'"
                                           [initialConfig]="currentDetailConfigs.design"
                                           (configChanged)="onFlyerDesignConfigChanged($event)">
                  </app-flyer-design-config>

                  <app-flyer-druck-config *ngSwitchCase="'druck'"
                                          [initialConfig]="currentDetailConfigs.druck"
                                          (druckKonfigurationChanged)="onFlyerDruckConfigChanged($event)">
                  </app-flyer-druck-config>

                  <div *ngSwitchCase="'verteilung'">
                    <p class="text-muted">Konfigurator für Verteilung demnächst verfügbar.</p>
                  </div>
                </ng-container>
              </div> <!-- Ende solution-accordion-body -->

            </div> <!-- Ende solution-option card (Akkordeon-Item) -->

            <!-- Validierungsmeldungen -->
            <div *ngIf="isFieldInvalid('selectedSolutions')" class="alert alert-danger mt-4 small">
              Bitte wählen Sie mindestens eine Dienstleistung aus.
            </div>
            <div *ngIf="solutionsForm.get('selectedSolutions')?.valid && selectedSolutionsValue.length > 0 && !areSelectedDetailConfigsValid()" class="alert alert-warning mt-3 small">
              Bitte füllen Sie alle erforderlichen Felder für die ausgewählten Dienstleistungen aus.
            </div>
          </form>
        </div>
        <div class="col-lg-4">
          <app-calculator></app-calculator>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss('cancel click')">Abbrechen</button>
    <button type="button" class="btn btn-primary"
            (click)="onSubmit()"
            [disabled]="solutionsForm.invalid || selectedSolutionsValue.length === 0 || !areSelectedDetailConfigsValid()">Übernehmen</button>
  </div>
</ng-template>
