<div class="cardbox contactdata">
  <div class="cardbox-body">
    <div class="row">
      <div class="col-lg-9">
        <h6 class="cardbox-step">Schritt 2</h6>
        <h3 class="cardbox-title">Kontaktdaten erfassen</h3>
        <p class="cardbox-text">Teilen Sie uns Ihre Kontaktdaten mit, damit wir sie erreichen können.</p>
        <!-- Anzeige der ausgefüllten Daten, falls Schritt abgeschlossen -->
        <div *ngIf="isStepCompleted && contactForm.valid && initialDataLoaded" class="mt-2 small">
          <i class="bi bi-check-circle-fill text-success"></i> Angaben vollständig:
          <strong>{{ contactForm.value.firstName }} {{ contactForm.value.lastName }}</strong>, {{ contactForm.value.email }}
        </div>
        <div *ngIf="!isStepCompleted && initialDataLoaded && contactForm.invalid && contactForm.dirty" class="mt-2 small text-danger">
          <i class="bi bi-exclamation-triangle-fill"></i> Bitte vervollständigen Sie Ihre Angaben.
        </div>
      </div>
      <div class="col-lg-3 align-self-center">
        <button type="button"
                [class]="isStepCompleted ? 'cardbox-button secondary' : 'cardbox-button'"
                [disabled]="disabled"
                [class.disabled]="disabled"
                (click)="openContactModal(contactModal)">
          {{ isStepCompleted ? 'Bearbeiten' : 'Weiter' }}
        </button>
      </div>
    </div>
  </div>
</div>

<ng-template #contactModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Kontaktdaten erfassen</h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <!-- Äußeres Formular -->
    <form [formGroup]="contactForm" (ngSubmit)="onSubmit()">
      <div class="row modal-content-spacer">
        <div class="col-lg-6">
          <p class="text-muted mb-4">Mit * gekennzeichnete Felder sind Pflichtfelder.</p>
          <div class="form-spacer">
            <fieldset class="mb-4">
              <legend>Persönliche Angaben</legend>

              <div class="mb-3 row">
                <label for="anrede" class="col-sm-4 col-form-label">Anrede *</label>
                <div class="col-sm-8">
                  <select class="form-select form-control border border-required"
                          id="anrede"
                          formControlName="gender"
                  [class.is-invalid]="isFieldInvalid('gender')">
                  <option value="" selected disabled>— Anrede wählen</option>
                  <option *ngFor="let opt of salutations" [value]="opt">
                    {{opt}}
                  </option>
                  </select>
                  <div *ngIf="isFieldInvalid('gender')" class="invalid-feedback">
                    Anrede ist erforderlich.
                  </div>
                </div>
              </div>

              <div class="mb-3 row">
                <label for="vorname" class="col-sm-4 col-form-label">Name *</label>
                <div class="col-sm-8">
                  <div class="input-group">
                    <input id="vorname"
                           type="text"
                           class="form-control border border-required"
                           placeholder="Max"
                           formControlName="firstName"
                           [class.is-invalid]="isFieldInvalid('firstName')">
                    <input id="nachname"
                           type="text"
                           class="form-control border border-required"
                           placeholder="Mustermann"
                           formControlName="lastName"
                           [class.is-invalid]="isFieldInvalid('lastName')">
                  </div>
                  <!-- Kombinierte Fehlermeldung für Vor- und Nachname -->
                  <div *ngIf="(isFieldInvalid('firstName') || isFieldInvalid('lastName'))" class="invalid-feedback d-block">
                    <span *ngIf="isFieldInvalid('firstName') && !isFieldInvalid('lastName')">Vorname ist erforderlich.</span>
                    <span *ngIf="!isFieldInvalid('firstName') && isFieldInvalid('lastName')">Nachname ist erforderlich.</span>
                    <span *ngIf="isFieldInvalid('firstName') && isFieldInvalid('lastName')">Vor- und Nachname sind erforderlich.</span>
                  </div>
                </div>
              </div>
            </fieldset>

            <fieldset class="mb-4">
              <legend>Kontaktinformationen</legend>

              <div class="mb-3 row">
                <label for="email" class="col-sm-4 col-form-label">E-Mail *</label>
                <div class="col-sm-8">
                  <input type="email"
                         id="email"
                         class="form-control border border-required"
                         placeholder="max.mustermann@musterfirma.ch"
                         autocomplete="on"
                         formControlName="email"
                         [class.is-invalid]="isFieldInvalid('email')">
                  <div *ngIf="fc['email'].errors?.['required'] && (fc['email'].dirty || fc['email'].touched)" class="invalid-feedback">
                    E-Mail ist erforderlich.
                  </div>
                  <div *ngIf="fc['email'].errors?.['email'] && (fc['email'].dirty || fc['email'].touched)" class="invalid-feedback">
                    Bitte eine gültige E-Mail-Adresse eingeben.
                  </div>
                </div>
              </div>

              <div class="mb-3 row">
                <label for="telefon" class="col-sm-4 col-form-label">Telefon *</label>
                <div class="col-sm-8">
                  <div class="input-group">
                    <input type="tel"
                           id="telefon"
                           class="form-control border border-required"
                    placeholder="+417998761234"
                    formControlName="phone"
                    [class.is-invalid]="isFieldInvalid('phone')">
                  </div>
                  <div *ngIf="fc['phone'].errors?.['required'] && (fc['phone'].dirty || fc['phone'].touched)" class="invalid-feedback">
                    Telefonnummer ist erforderlich.
                  </div>
                  <div *ngIf="fc['phone'].errors?.['pattern'] && (fc['phone'].dirty || fc['phone'].touched)" class="invalid-feedback">
                    Ungültiges Telefonformat.
                  </div>
                </div>
              </div>
            </fieldset>

            <fieldset class="mb-4">
              <legend>Firmenangaben</legend>

              <div class="mb-3 row">
                <label for="firma" class="col-sm-4 col-form-label">Firma</label>
                <div class="col-sm-8">
                  <input type="text"
                         id="firma"
                         class="form-control"
                         placeholder="Musterfirma AG"
                         formControlName="companyName">
                </div>
              </div>

              <div class="mb-3 row">
                <label for="strasse" class="col-sm-4 col-form-label">Strasse & Hausnummer *</label>
                <div class="col-sm-8">
                  <div class="input-group">
                    <input id="strasse"
                           type="text"
                           class="form-control w-75 border-required"
                    placeholder="Musterweg"
                    formControlName="street"
                    [class.is-invalid]="isFieldInvalid('street')">
                    <input id="hausnummer"
                           type="text"
                           class="form-control w-25 border-required"
                    placeholder="248"
                    formControlName="houseNumber"
                    [class.is-invalid]="isFieldInvalid('houseNumber')">
                  </div>
                  <div *ngIf="(isFieldInvalid('street') || isFieldInvalid('houseNumber'))" class="invalid-feedback d-block">
                    <span *ngIf="isFieldInvalid('street') && !isFieldInvalid('houseNumber')">Strasse ist erforderlich.</span>
                    <span *ngIf="!isFieldInvalid('street') && isFieldInvalid('houseNumber')">Hausnummer ist erforderlich.</span>
                    <span *ngIf="isFieldInvalid('street') && isFieldInvalid('houseNumber')">Strasse und Hausnummer sind erforderlich.</span>
                  </div>
                </div>
              </div>

              <div class="mb-3 row">
                <label for="plz" class="col-sm-4 col-form-label">PLZ & Ort *</label>
                <div class="col-sm-8">
                  <div class="input-group">
                    <input id="plz"
                           type="text"
                           class="form-control w-25 border-required"
                    placeholder="8001"
                    formControlName="zip"
                    [class.is-invalid]="isFieldInvalid('zip')">
                    <input id="ort"
                           type="text"
                           class="form-control w-75 border-required"
                    placeholder="Zürich"
                    formControlName="city"
                    [class.is-invalid]="isFieldInvalid('city')">
                  </div>
                  <div *ngIf="fc['zip']?.errors?.['required'] && (fc['zip'].dirty || fc['zip'].touched) && !isFieldInvalid('city')" class="invalid-feedback d-block">
                    PLZ ist erforderlich.
                  </div>
                  <div *ngIf="fc['zip']?.errors?.['pattern'] && (fc['zip'].dirty || fc['zip'].touched) && !isFieldInvalid('city')" class="invalid-feedback d-block">
                    PLZ muss 4-stellig sein.
                  </div>
                  <div *ngIf="isFieldInvalid('city') && !isFieldInvalid('zip')" class="invalid-feedback d-block">
                    Ort ist erforderlich.
                  </div>
                  <div *ngIf="isFieldInvalid('zip') && isFieldInvalid('city')" class="invalid-feedback d-block">
                    PLZ und Ort sind erforderlich.
                  </div>
                  <div *ngIf="fc['zip']?.errors?.['pattern'] && isFieldInvalid('city')" class="invalid-feedback d-block">
                    PLZ muss 4-stellig sein und Ort ist erforderlich.
                  </div>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </div>

      <div class="modal-footer px-0 pb-0">
        <button type="submit" class="btn btn-primary" [disabled]="contactForm.invalid">
          Speichern
        </button>
      </div>
    </form>
  </div>
</ng-template>
